<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]>      <html class="no-js"> <!--<![endif]-->
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="description" content="" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>CF455D 题解</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/purecss@2.0.6/build/pure-min.css"
      integrity="sha384-Uu6IeWbM+gzNVXJcM9XV3SohHtmWE+3VGi496jvgX1jyvDTXfdK+rfZc8C1Aehk5"
      crossorigin="anonymous"
    />
    <link
      href="//fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext"
      rel="stylesheet"
      type="text/css"
    />
    <link rel="stylesheet" href="https://unpkg.com/purecss@2.0.6/build/grids-responsive-min.css" />
    <link rel="stylesheet" href="https://unpkg.com/font-awesome@4.7.0/css/font-awesome.min.css" />
    <link rel="stylesheet" href="https://unpkg.com/katex@0.15.1/dist/katex.min.css" />
    <link rel="stylesheet" href="https://unpkg.com/highlight.js@11.3.1/styles/atom-one-light.css" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/github-markdown-css@5.1.0/github-markdown-light.css"
    />
  <script defer src="../js/post.b40d710.js"></script><script defer src="../js/post/solution-cf455d.77e5f92.js"></script><link href="../css/post-solution-cf455d.3cba3c7.css" rel="stylesheet"></head>

  <body>
    <!--[if lt IE 7]>
      <p class="browsehappy">
        You are using an <strong>outdated</strong> browser. Please
        <a href="#">upgrade your browser</a> to improve your experience.
      </p>
    <![endif]-->
    <div id="wrap">
      <div id="sidebar" class="pure-menu">
  <a class="pure-menu-heading" href="/index.html">yzy1</a>
  <ul class="pure-menu-list">
    <li class="pure-menu-item">
      <a href="/index.html" class="pure-menu-link"><i class="fa fa-home"></i>博客</a>
    </li>
    <li class="pure-menu-item">
      <a href="/index.html" class="pure-menu-link"><i class="fa fa-tags"></i>标签</a>
    </li>
    <li class="pure-menu-item">
      <a href="/index.html" class="pure-menu-link"><i class="fa fa-file-code-o"></i>模板</a>
    </li>
    <li class="pure-menu-item menu-item-divided">
      <a href="/index.html" class="pure-menu-link"><i class="fa fa-external-link"></i>友链</a>
    </li>
    <li class="pure-menu-item">
      <a href="/about.html" class="pure-menu-link"><i class="fa fa-user"></i>关于</a>
    </li>
  </ul>
</div>

      <div id="main">

<header>
  <h1>CF455D 题解</h1>
</header>
<section class="content">
  <div class="markdown-body"><p>考虑分块，每 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msqrt><mi>n</mi></msqrt></mrow><annotation encoding="application/x-tex">\sqrt n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.04em;vertical-align:-0.2397em;"></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8003em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="padding-left:0.833em;">n</span></span><span style="top:-2.7603em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice"><path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"></path></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2397em;"><span></span></span></span></span></span></span></span></span></span> 个元素分成一块，每个块内维护 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi>n</mi><mi>t</mi><mo stretchy="false">(</mo><mi>b</mi><mo separator="true">,</mo><mi>i</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">cnt(b,i)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">c</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mopen">(</span><span class="mord mathnormal">b</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">i</span><span class="mclose">)</span></span></span></span></span> 表示 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span></span> 这个数在 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi></mrow><annotation encoding="application/x-tex">b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">b</span></span></span></span></span> 号块中出现了几次，维护 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mi>q</mi><mo stretchy="false">(</mo><mi>b</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">dq(b)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">d</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mopen">(</span><span class="mord mathnormal">b</span><span class="mclose">)</span></span></span></span></span> 用一个 <code>deque</code> 表示出 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi></mrow><annotation encoding="application/x-tex">b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">b</span></span></span></span></span> 号块内的所有元素。</p>
<p>对于 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span></span> 操作，如果 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi></mrow><annotation encoding="application/x-tex">l</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span></span></span></span></span> 与 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi></mrow><annotation encoding="application/x-tex">r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span></span> 在同一个块里，直接暴力去做即可。如果不在，则将最后一个元素 insert 进第一个元素所在的块中，接着 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>b</mi><msub><mi>l</mi><mi>l</mi></msub><mo separator="true">,</mo><mi>b</mi><msub><mi>l</mi><mi>r</mi></msub><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">(bl_l,bl_r]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">b</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">b</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">]</span></span></span></span></span> 之间的所有块，把上一个块的最后一个元素移到当前块中，并更新 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi>n</mi><mi>t</mi></mrow><annotation encoding="application/x-tex">cnt</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">c</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span></span></span></span></span> 值。以保证块内元素数仍为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msqrt><mi>n</mi></msqrt></mrow><annotation encoding="application/x-tex">\sqrt n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.04em;vertical-align:-0.2397em;"></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8003em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="padding-left:0.833em;">n</span></span><span style="top:-2.7603em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice"><path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"></path></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2397em;"><span></span></span></span></span></span></span></span></span></span>。</p>
<p>对于 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn></mrow><annotation encoding="application/x-tex">2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">2</span></span></span></span></span> 操作，零散块暴力查询，整块直接读 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi>n</mi><mi>t</mi></mrow><annotation encoding="application/x-tex">cnt</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">c</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span></span></span></span></span> 值相加即可。</p>
<p><strong>另外需要特殊注意的是：</strong> 如果你 RE on test 9，如果你写了类似</p>
<pre><code class="hljs language-cpp">dq[bl[r]].<span class="hljs-built_in">erase</span>(dq[bl[r]].<span class="hljs-built_in">begin</span>() + r - lbl[r]);
</code></pre>
<p>这种的语法，它会因为 <code>dq[bl[r]].begin() + r</code> 跑到了 deque 外面而 RE。</p>
<p>改成这样即可 AC：</p>
<pre><code class="hljs language-cpp">dq[bl[r]].<span class="hljs-built_in">erase</span>(dq[bl[r]].<span class="hljs-built_in">begin</span>() + (r - lbl[r]));
</code></pre>
<h3>Code</h3>
<pre><code class="hljs language-cpp"><span class="hljs-keyword">constexpr</span> <span class="hljs-type">int</span> N = <span class="hljs-number">1e5</span> + <span class="hljs-number">9</span>;
<span class="hljs-keyword">constexpr</span> <span class="hljs-type">int</span> B = <span class="hljs-number">333</span>;

<span class="hljs-type">int</span> n, a[N], cnt[B][N], bl[N], lbl[N], rbl[N], sz;
deque&#x3C;<span class="hljs-type">int</span>> dq[B];

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Init</span><span class="hljs-params">()</span> </span>{
  sz = <span class="hljs-built_in">max</span>(<span class="hljs-number">3</span>, (<span class="hljs-type">int</span>)<span class="hljs-built_in">sqrt</span>(n));
  <span class="hljs-built_in">re</span> (i, n)
    bl[i] = (i - <span class="hljs-number">1</span>) / sz + <span class="hljs-number">1</span>, lbl[i] = (bl[i] - <span class="hljs-number">1</span>) * sz + <span class="hljs-number">1</span>, rbl[i] = <span class="hljs-built_in">min</span>(n, bl[i] * sz);
  <span class="hljs-built_in">ste</span>(x, <span class="hljs-number">1</span>, n, sz) {
    <span class="hljs-built_in">rep</span> (i, lbl[x], rbl[x])
      dq[bl[x]].<span class="hljs-built_in">push_back</span>(a[i]), ++cnt[bl[x]][a[i]];
  }
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Mov</span><span class="hljs-params">(<span class="hljs-type">int</span> l, <span class="hljs-type">int</span> r)</span> </span>{
  <span class="hljs-keyword">if</span> (bl[l] == bl[r]) {
    <span class="hljs-type">int</span> b = bl[l];
    <span class="hljs-type">int</span> x = dq[b][r - lbl[l]];
    dq[b].<span class="hljs-built_in">erase</span>(dq[b].<span class="hljs-built_in">begin</span>() + (r - lbl[l]));
    dq[b].<span class="hljs-built_in">insert</span>(dq[b].<span class="hljs-built_in">begin</span>() + (l - lbl[l]), x);
    <span class="hljs-keyword">return</span>;
  }
  dq[bl[l]].<span class="hljs-built_in">insert</span>(dq[bl[l]].<span class="hljs-built_in">begin</span>() + (l - lbl[l]), dq[bl[r]][r - lbl[r]]);
  ++cnt[bl[l]][dq[bl[r]][r - lbl[r]]];
  --cnt[bl[r]][dq[bl[r]][r - lbl[r]]];
  dq[bl[r]].<span class="hljs-built_in">erase</span>(dq[bl[r]].<span class="hljs-built_in">begin</span>() + (r - lbl[r]));
  <span class="hljs-built_in">rep</span> (b, bl[l] + <span class="hljs-number">1</span>, bl[r]) {
    <span class="hljs-type">int</span> t = dq[b - <span class="hljs-number">1</span>].<span class="hljs-built_in">back</span>();
    dq[b].<span class="hljs-built_in">push_front</span>(t);
    ++cnt[b][t];
    dq[b - <span class="hljs-number">1</span>].<span class="hljs-built_in">pop_back</span>();
    --cnt[b - <span class="hljs-number">1</span>][t];
  }
}

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">Ask</span><span class="hljs-params">(<span class="hljs-type">int</span> l, <span class="hljs-type">int</span> r, <span class="hljs-type">int</span> k)</span> </span>{
  <span class="hljs-type">int</span> res = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">if</span> (bl[l] == bl[r]) {
    <span class="hljs-type">int</span> b = bl[l];
    <span class="hljs-built_in">rep</span> (i, l, r) {
      <span class="hljs-keyword">if</span> (dq[b][i - lbl[l]] == k) ++res;
    }
    <span class="hljs-keyword">return</span> res;
  }
  res += <span class="hljs-built_in">Ask</span>(l, rbl[l], k);
  <span class="hljs-built_in">rep</span> (b, bl[l] + <span class="hljs-number">1</span>, bl[r] - <span class="hljs-number">1</span>)
    res += cnt[b][k];
  res += <span class="hljs-built_in">Ask</span>(lbl[r], r, k);
  <span class="hljs-keyword">return</span> res;
}

<span class="hljs-function"><span class="hljs-type">signed</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-built_in">in</span>(n)(a, n);
  <span class="hljs-built_in">Init</span>();
  <span class="hljs-type">int</span> lastans = <span class="hljs-number">0</span>;
  <span class="hljs-built_in">re</span> (_, <span class="hljs-built_in">in</span>()) {
    <span class="hljs-type">int</span> op = <span class="hljs-built_in">in</span>(), l = (<span class="hljs-built_in">in</span>() + lastans - <span class="hljs-number">1</span>) % n + <span class="hljs-number">1</span>, r = (<span class="hljs-built_in">in</span>() + lastans - <span class="hljs-number">1</span>) % n + <span class="hljs-number">1</span>;
    <span class="hljs-keyword">if</span> (l > r) <span class="hljs-built_in">swap</span>(l, r);
    <span class="hljs-keyword">if</span> (op == <span class="hljs-number">1</span>)
      <span class="hljs-built_in">Mov</span>(l, r);
    <span class="hljs-keyword">else</span> {
      <span class="hljs-type">int</span> k = (<span class="hljs-built_in">in</span>() + lastans - <span class="hljs-number">1</span>) % n + <span class="hljs-number">1</span>;
      lastans = <span class="hljs-built_in">Ask</span>(l, r, k);
      <span class="hljs-built_in">out</span>(lastans)(<span class="hljs-string">'\n'</span>);
    }
  }
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre></div>
</section>
      </div>
    </div>
    <script src="https://unpkg.com/jquery@3.6.0/dist/jquery.min.js"></script>
  </body>
</html>

