---
title: P7942 题解
tags: ["题解"]
uptime: 1636685501
---

考虑将贡献分为两种——字符串内部的贡献和拼接处产生的贡献。第一种贡献直接暴力求即可，重点是第二种。考虑一个有长度为 $i$ 的连续极大后缀的字符串和一个长度为 $j$ 的极大连续前缀的字符串相拼接。会对答案造成 $i+j-k+1$ 的贡献。我们可以预处理出有极大前缀为字符 $c$，长度为 $i$ 的字符串数量 $\operatorname{pre}(c,i)$，极大后缀为字符 $c$，长度为 $j$ 的字符串数量 $\operatorname{suf}(c,j)$。枚举 $c,i,j$，从两个集合各选出一个字符串拼接在一起的方案数为 $\operatorname{suf}(c,j)\operatorname{pre}(c,i)$。考虑将「所有的全排列中 $k$ 连串数量的总和」转化为「随机洗牌后 $k$ 连串数量的期望」。从 $n$ 个位置中选择两个位置共有 $\operatorname{C}_n^2 = n(n-1)$ 种方案。而这 $n(n-1)$ 种方案中只有 $(n-1)$ 种使得两个字符串正好相邻。也就是说，随机洗牌后这两个字符串正好相邻形成 $k$ 连串的概率为 $\dfrac{n-1}{n(n-1)}=\dfrac 1 n$。所以对答案的贡献为：

$$
\dfrac{\operatorname{suf}(c,j)\operatorname{pre}(c,i)(i+j-k+1)} n.
$$

但是这会忽略一种特殊情况，试想有这样一组数据：

```
-1
2 3 2
aba
cde
```

正确答案显然为 $0$，但是根据上面那种方式得到的答案为 $1$，原因是因为字符串 `aba` 的前后缀有相同的字符，计算答案时会「自己和自己拼接」而造成贡献，我们可以记录多少个字符串有着极大前后缀字符均为 $c$ 的，前缀长度为 $i$，后缀长度为 $j$ 的字符串数量 $\operatorname{same}(c,i,j)$，计算答案时减去即可。故最终答案为：

$$
\sum_{c=\verb!a!}^{\verb!z!}\sum_{i=1}^{m-1}\sum_{j=1}^{m-1}\dfrac{(\operatorname{suf}(c,i)\operatorname{pre}(c,i)-\operatorname{same}(c,i,j))(i+j-k+1)} n.
$$
